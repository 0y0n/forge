# =============================================================================
# roles/kvm/tasks/main.yml
# 1) Install QEMU / libvirt / virt-manager
# 2) Generate an SSH keypair for guest access
# 3) Download Ubuntu cloud image (cached)
# 4) Provision dev-workstation VM
# 5) Provision forge-infra VM
# 6) Wait until both VMs expose SSH on the mapped host ports
# =============================================================================
---
# ── packages ─────────────────────────────────────────────────────────────────
- name: "kvm | install virtualisation stack"
  become: true
  ansible.builtin.apt:
    name:
      - qemu-kvm
      - libvirt-bin
      - virt-manager
      - virtinst            # virt-install CLI
      - cloud-init
      - nmap                # for portcheck in wait task
    state: present
    update_cache: true

- name: "kvm | enable & start libvirtd"
  become: true
  ansible.builtin.systemd:  
    name:    libvirtd
    enabled: true
    state:   started

- name: "kvm | add current user to libvirt group"
  ansible.builtin.user:
    name:   "{{ ansible_env.SUDO_USER | default(ansible_env.USER) }}"
    groups: libvirt
    append: true

# ── SSH key ──────────────────────────────────────────────────────────────────
- name: "kvm | generate SSH keypair for VM guests"
  ansible.builtin.command: >
    ssh-keygen -t ed25519 -N "" -f {{ forge_ssh_key }}
  args:
    creates: "{{ forge_ssh_key }}"

- name: "kvm | read public key into var"
  ansible.builtin.slurp:
    src: "{{ forge_ssh_pub }}"
  register: forge_pubkey_b64

- name: "kvm | set pubkey fact"
  ansible.builtin.set_fact:
    forge_pubkey: "{{ forge_pubkey_b64.content | b64decode }}"

# ── cloud image ──────────────────────────────────────────────────────────────
- name: "kvm | ensure vm-images directory"
  ansible.builtin.file:
    path:  "{{ forge_vm_images }}"
    state: directory
    mode:  "0755"

- name: "kvm | download Ubuntu 24.04 cloud image (cached)"
  ansible.builtin.get_url:
    url:  "{{ ubuntu_cloud_image_url }}"
    dest: "{{ forge_vm_images }}/noble-server-cloudimg-amd64.img"
    mode: "0644"

# ── provision helper (imported per-VM) ───────────────────────────────────────
- name: "kvm | provision dev-workstation"
  ansible.builtin.include_tasks: provision_vm.yml
  vars:
    vm: "{{ vm_dev_workstation }}"

- name: "kvm | provision forge-infra"
  ansible.builtin.include_tasks: provision_vm.yml
  vars:
    vm: "{{ vm_forge_infra }}"
