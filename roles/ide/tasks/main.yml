# =============================================================================
# roles/ide/tasks/main.yml
# Visual Studio Code  (desktop .deb)  + JetBrains Community Editions.
# Extensions are installed via the `code` CLI in a post-install task.
# =============================================================================
---
# ── Visual Studio Code ───────────────────────────────────────────────────────
- name: "ide | install keyring support for VS Code secrets"
  become: true
  ansible.builtin.apt:
    name:
      - gnome-keyring
      - libsecret-1-0
      - libsecret-common
      - libsecret-tools
      - seahorse
    state: present
# ── Visual Studio Code ───────────────────────────────────────────────────────
- name: "ide | prepare apt dependencies"
  become: true
  ansible.builtin.apt:
    name: [wget, gpg, apt-transport-https]
    state: present
    update_cache: true

- name: "ide | prevent vscode from injecting its own repo"
  become: true
  ansible.builtin.debconf:
    name: "code"
    question: "code/add-microsoft-repo"
    value: "false"
    vtype: "boolean"

- name: "ide | add Microsoft GPG key"
  become: true
  ansible.builtin.get_url:
    url: https://packages.microsoft.com/keys/microsoft.asc
    dest: /usr/share/keyrings/microsoft.asc
    mode: '0644'

- name: "ide | dearmor GPG key"
  become: true
  ansible.builtin.command:
    cmd: gpg --dearmor -o /usr/share/keyrings/microsoft.gpg /usr/share/keyrings/microsoft.asc
    creates: /usr/share/keyrings/microsoft.gpg

- name: "ide | add VS Code repo (modern DEB822 format)"
  become: true
  ansible.builtin.deb822_repository:
    name: vscode
    types: [deb]
    uris: "https://packages.microsoft.com/repos/code"
    suites: [stable]
    components: [main]
    signed_by: /usr/share/keyrings/microsoft.gpg
    state: present

- name: "ide | cleanup legacy vscode list to avoid warnings"
  become: true
  ansible.builtin.file:
    path: /etc/apt/sources.list.d/vscode.list
    state: absent

- name: "ide | install VS Code"
  become: true
  ansible.builtin.apt:
    name: code
    state: present
    update_cache: true

# ── VS Code extensions ───────────────────────────────────────────────────────
- name: "ide | list installed VS Code extensions"
  ansible.builtin.command: "code --list-extensions"
  register: installed_extensions
  changed_when: false
  # no failure even if empty
  failed_when: false

- name: "ide | install VS Code extensions"
  ansible.builtin.command: >
    code --install-extension {{ item }} 
  loop:
    - rust-lang.rust-analyzer
    - ms-python.python
    - ms-python.vscode-pylance
    - vscjava.vscode-java-pack
    - ms-vscode-remote.remote-ssh
    - ms-vscode-remote.vscode-remote-extensionpack
    - saoudrizwan.claude-dev
    - bazelbuild.vscode-bazel
  # run only if not in the list previously collected
  when: item.lower() not in installed_extensions.stdout_lines | map('lower')

# ── JetBrains Community Editions ─────────────────────────────────────────────
- name: "ide | install JetBrains dependencies"
  ansible.builtin.apt:
    name:
      - libfuse2          
      - libnss3           
      - libxkbcommon-x11-0
      - libatk-bridge2.0-0
    state: present
  become: true

- name: "ide | provide toolbox download link in a README"
  ansible.builtin.copy:
    dest: "~/Desktop/INSTALL_JETBRAINS.txt"
    content: |
      To install your JetBrains IDE (to complexe to controlfrom ansible):
      1. Download Toolbox : https://www.jetbrains.com/toolbox-app/
      2. ExtrayezExtract and start AppImage.
      3. Connect with your JetBrains account.
    mode: '0644'